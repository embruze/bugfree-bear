---
title: "Categorical Data Analysis"
author: "Emilie Bruzelius (eb2674)"
output: html_document
---

<h4>Homework 3 </h4>
<h4>P8120 Summer 2015 </h4>
<h4>Due: Monday, June 15 (5:00 pm) </h4>

```{r error=FALSE, message=FALSE, warning=FALSE}
rm(list=ls())
library(pwr)
library(epitools)
library(epiR)
library(scrime)
library(stats)
library(coin)
```

<h3>1.</h3>
A case-control study is being planned to study the relationship between alcohol consumption and coronary death (CD).  In particular, investigators are interested in the effects of alcohol consumption within 24 hours of a CD.  The exposure variable is whether or not the subject consumed alcohol within 24 hours of death. Cases are defined as those who suffered CD and controls are those who died of other causes.  Use SAS to complete each part below.

<h3>1.a.</h3>
300 cases and 300 controls will be recruited and their exposure status will be recorded.  It is anticipated that 5% of controls consumed alcohol within 24 hours of death and the OR that investigators would like to be able to detect is 2.0 (OR for CD comparing those who drank alcohol to those who did not).  Assuming that a 2-sided, α = 0.05 level test will be conducted, what power will this test have for detecting a significant association between alcohol consumption within 24 hours and CD?

```{r error=FALSE, message=FALSE, warning=FALSE}
ES.h(0.09523, 0.05)
pwr.2p.test(h=0.1764014, n=300, sig.level=0.05)
```

**The test will have 57.95% power to detect a significant association between alcohol consumption within 24 hours and CD.**

<h3>1.b.</h3>
Investigators still wish to carry out a 2-sided, α = 0.05 level test with the same exposure probability among controls and the same OR.  They also wish to keep the number of cases and controls balanced, but they want their test to achieve 80% power.  How many subjects will they need to recruit?  How does this new sample size compare to the sample size in part (a)?

```{r error=FALSE, message=FALSE, warning=FALSE}
pwr.2p.test(h=0.1764014, sig.level=0.05, power=.80)
```
**N = 504.4668, so 505 participants are required per group. The sample size in part B is larger than the 300 participants noted in part A. As the investigators want 80% power to detect the association they require a larger sample size than is specified in part A - i.e. as the desired power increases, the necessary sample size also increases.** 

<h3>1.c.</h3> 
Investigators realize that it will be more difficult to ascertain cases than controls.  Instead they decide to recruit twice as many controls as cases.  With all else the same as in part (a), how many cases and how many controls will they need to recruit?  How does the total sample size in part (a) compare to your new total sample size?

```{r error=FALSE, message=FALSE, warning=FALSE}
pwr.2p2n.test(h = 0.1764014, n1 = 300, n2 = 600, sig.level = 0.05)
```
**The test will have 70.36% power to detect a significant association between alcohol consumption within 24 hours and CD.**

<h3>1.d.</h3>
Consider part (b) again. What happens to the sample size calculation when the level of the test is decreased?

**Power is a function of the significance level, sample size and hypothesized effect size. So as the alpha decreases the power decreases; as the number of subjects decreases the power also decreases; as the hypothesizes effect size decreases the power also decreases.**

<h3>1.e.</h3>
Consider part (b) again.  What happens to the sample size calculation when the power of the test is decreased? 

**When the power decreases the sample size decreases. I think its easier to think of it in the other direction - as the sample size decreses the power also decreases. As the sample size decreases increases you are subtracting a larger quantity from the statistic so ultimately the fraction is smaller so the probability of z > small number is bigger than z > big number.** 

<h3>1.f.</h3>
Consider part (b) again.  What happens to the sample size calculation when the OR is closer to 1?

**As the OR moves closer to 1 the effect size is decreasing. Therefore the you are subtracting a bigger quantity leaving a smaller number on the right-hand side of the inequality. Therefore the smaller the OR the less likely you are be able to detect it and conversely the larger the OR the more likely you are to detect it.** 

<h3>2.</h3> 
Dairy cattle are cattle that are bred for their ability to produce large quantities of milk.  Lameness is a condition that can be detrimental to cattle since it can be painful and result in deleterious effects on the animal’s welfare.  It is a condition in which cows have difficulty moving and especially walking.  Investigators are interested in whether milk production in dairy cows is associated with whether or not the cow becomes lame.  They think that the age of the cow (young or old) may confound and/or modify the relationship between milk production and lameness and so they collect information on the age of the cows as well.  The data that cross classifies lame status and milk production status is stratified by age and is provided in the tables below.  Use SAS to complete each part.     

<h3>2.a.</h3> 
Ignoring age, report the estimate for the OR and its corresponding 95% confidence interval.  Interpret both.  

```{r error=FALSE, message=FALSE, warning=FALSE}
a <- 43+25
b <- 130+286
c <- 26+14
d <- 277+287
cows <- matrix(c(68, 416, 40, 564), 2, 2, byrow=TRUE)
epi.2by2(cows)
```
**2.30 (1.50, 3.57)**

**Milk producing cows have 2.30 the odds of lameness compared to non-milk producing cows. We are 95% confident that the true odds ratio lies between 1.5312 and 3.4954.**

<h3>2.b.</h3> 
Ignoring age, is milk production associated with lameness?  Justify your response.

**Based on the 95% confidence interval which does not include 1, in these data there appears to be an association between milk production and lameness in dairy cows.**

<h3>2.c.</h3> 
Does age modify the association between milk production and lameness?  Justify your response with a formal test.

```{r error=FALSE, message=FALSE, warning=FALSE}
cowsyoung <- matrix(c(43, 130, 26, 277), 2, 2, byrow=TRUE)
cowsold <- matrix(c(25, 286, 14, 287), 2, 2, byrow=TRUE)
young <- epi.2by2(cowsyoung, "cohort.count",
conf.level = 0.95, units = 100,  homogeneity = "breslow.day")
old <- epi.2by2(cowsold, "cohort.count",
conf.level = 0.95, units = 100,  homogeneity = "breslow.day")
cows.strat <- epitable(43, 130, 25, 286, 26, 277, 14, 287, ncol =4, byrow = TRUE)
```

**ORyoung = odds ratio for lameness comparing those with high yeild to those with low yeild among young cows.**

**ORold = odds ratio for lameness comparing those with high yeild to those with low yeild among old cows.**

* **H0: ORyoung = ORold**
* **H1: ORyoung ≠ ORold**
* **Set α = 0.05**
* **Under H0, X^2 BD ~ X^2 1**
* **From the output: X^2 BD = ?????**
* **P-value < 0.0001**
* **So we can reject H0 and claim that at a 5% level of significance there is enough evidence to reject the null hypothesis and conclude that age status modifies the relationship between milk production and lameness.**

<h3>2.d.</h3> 
Based on your response in part (c), does it make sense to report the Mantel-Haenszel estimate of the OR?  Explain why or why not?

**After adjusting for age, cows who had a high milk production yeild have the same odds of lameness as those who had a low yeild.**

<h3>2.e.</h3> 
Does age confound the association between milk production and lameness?  Justify your response by using the appropriate measures and making the appropriate comparisons.  (Regardless of whether it is true or not, assume that age satisfies all conditions for being a potential confounder…you don’t need to check for this exercise.)

**The crude is ??? and the Mantel-Haenszel is ???. Because the crude and the adjusted are so different, there is evidence that age confounds the association between milk production and lameness.**

<h3>2.f.</h3> 
Write a short paragraph summarizing your findings in parts (a) – (e).  Be sure to address the research interests.

**The initial crude analysis found a relationship between milk production yeild and lameness — those who high yeild had 3.9304 times the odds of lameness compared with those with low yeild.  We then proceeded to stratify the analysis by age and examine the association between milk produciton and lameness.  The odds ratios from each stratum were the same and the Breslow-Day test was not significant, and therefore did not give us any evidence of effect measure 
modification; the relationship between milk production and lameness did not differ by age. We calculated the odds ratio for the relationship between milk production and lameness  adjusting for age, the Mantel-Haenszel OR, and found it to be equal to 1.  The results from our adjusted hypothesis test did not yield enough evidence to reject the null and  conclude that the Mantel-Haenszel OR was different from 1, and our 95% confidence interval for the Mantel-Haenszel OR contained 1.  We have evidence that age confounded the relationship between milk production and lameness, and after adjusting for age; there is no evidence that milk production and lameness are related.**

<h3>3.</h3> 
A new vaccine has been developed and investigators are interested in whether it has any effect on the rate of infection for a particular disease.  A randomized controlled trial was conducted to compare the new vaccine to placebo with respect to rate of infection.  You are the lead statistician for this trial and are given the task of analyzing the data and reporting back to the investigators.  Use SAS to complete each part.  The data is given in the table below:

```{r error=FALSE, message=FALSE, warning=FALSE}
vac <- matrix(c(191, 98, 3139, 1581), 2, 2, byrow=TRUE)
epi.2by2(vac)
tab2by2.test(vac, y = NULL,correction = FALSE) 
```

<h3>3.a.</h3> 
Estimate the OR and give the corresponding 95% confidence interval for the association between treatment and infection status.  Interpret both. 

OR = odds ratio for infection comparing those who received the vaccine to those who did not receive the vaccine.
** Odds Ratio: 0.98 95% CI: (0.76, 1.28)**

<h3>3.b.</h3> 
Conduct a test of the null hypothesis that treatment and infection status are independent.

**Step 1. Write H0, H1 and alpha**
*OR = odds ratio for infection comparing those who received the vaccine to those who did not receive the vaccine.
*H0: OR = 1
*H1: OR ≠ 1
*Set α = 0.05

**Step 2: Calculate expected frequencies.  Write down assumptions and test statistic.**
```{r error=FALSE, message=FALSE, warning=FALSE}
a <- (289*3330)/5009
b <- (289*1679)/5009
c <- (4720*3330)/5009
d <- (4728*1679)/5009
a
b
c
d
```

**Assumptions are satisfied because every expected cell count has a frequency greater or equal to 5.**
```{r error=FALSE, message=FALSE, warning=FALSE}
chisq.test(vac) 
```

**Step 3: test**
Under H0, X^2 ~ X^2 1
Pearson's Chi-squared test with Yates' continuity correction
X-squared = 0.0065024, df = 1, p-value = 0.9357

**Step 4: decision**
These data do not provide sufficient evidence to reject the null hypothesis.

**Step 5: conclusion**
At the 5% level of significance, we do not have enough evidence to reject the null hypothesis and conclude that there is a significant association between receiving the vaccine and developing an infection.

<h3>3.c.</h3> 
Investigators thought that it may be informative to look at the results stratified by race.  The data is provided below.  For each table repeat the analysis that you performed in part (a).

```{r error=FALSE, message=FALSE, warning=FALSE}
vac.tot <- epitable(179, 81, 4, 9, 8, 8, 2824, 1427, 199, 102, 116, 25, ncol=6, byrow = TRUE)
```

White and Hispanic
```{r error=FALSE, message=FALSE, warning=FALSE}
vac.wh <- matrix(c(179, 81, 2824, 1427), 2, 2, byrow=TRUE)
epi.2by2(vac.wh)
tab2by2.test(vac.wh, y = NULL,correction = FALSE) 
```

**Step 1. Write H0, H1 and alpha**
*OR = odds ratio for infection comparing those who received the vaccine to those who did not receive the vaccine among white and hispanic participants.
*H0: OR = 1
*H1: OR ≠ 1
*Set α = 0.05

**Step 2: Calculate expected frequencies.  Write down assumptions and test statistic.**
```{r error=FALSE, message=FALSE, warning=FALSE}
a.wh <- (260*3003)/4511
b.wh <- (260*1508)/4511
c.wh <- (4251*3003)/4511
d.wh <- (4251*1508)/4511
a.wh
b.wh
c.wh
d.wh
```

**Assumptions are satisfied because every expected cell count has a frequency greater or equal to 5.**
```{r error=FALSE, message=FALSE, warning=FALSE}
chisq.test(vac.wh) 
```
**Step 3: test**
Under H0, X^2 ~ X^2 1
Pearson's Chi-squared test with Yates' continuity correction
X-squared = 0.53805, df = 1, p-value = 0.4632

**Step 4: decision**
These data do not provide sufficient evidence to reject the null hypothesis.

**Step 5: conclusion**
At the 5% level of significance, we do not have enough evidence to reject the null hypothesis and conclude that there is a significant association between receiving the vaccine and developing an infection among white and hispanic patients.

White and Hispanic
```{r error=FALSE, message=FALSE, warning=FALSE}
vac.wh <- matrix(c(179, 81, 2824, 1427), 2, 2, byrow=TRUE)
epi.2by2(vac.wh)
tab2by2.test(vac.wh, y = NULL,correction = FALSE) 
```

**Step 1. Write H0, H1 and alpha**
*OR = odds ratio for infection comparing those who received the vaccine to those who did not receive the vaccine among white and hispanic participants.
*H0: OR = 1
*H1: OR ≠ 1
*Set α = 0.05

**Step 2: Calculate expected frequencies.  Write down assumptions and test statistic.**
```{r error=FALSE, message=FALSE, warning=FALSE}
a.wh <- (260*3003)/4511
b.wh <- (260*1508)/4511
c.wh <- (4251*3003)/4511
d.wh <- (4251*1508)/4511
a.wh
b.wh
c.wh
d.wh
```

**Assumptions are satisfied because every expected cell count has a frequency greater or equal to 5.**
```{r error=FALSE, message=FALSE, warning=FALSE}
chisq.test(vac.wh) 
```
**Step 3: test**
Under H0, X^2 ~ X^2 1
Pearson's Chi-squared test with Yates' continuity correction
X-squared = 0.53805, df = 1, p-value = 0.4632

**Step 4: decision**
These data do not provide sufficient evidence to reject the null hypothesis.

**Step 5: conclusion**
At the 5% level of significance, we do not have enough evidence to reject the null hypothesis and conclude that there is a significant association between receiving the vaccine and developing an infection among white and hispanic patients.

Black participants
```{r error=FALSE, message=FALSE, warning=FALSE}
vac.b <- matrix(c(4, 9, 199, 102), 2, 2, byrow=TRUE)
epi.2by2(vac.b)
tab2by2.test(vac.b, y = NULL,correction = FALSE) 
```

**Step 1. Write H0, H1 and alpha**
*OR = odds ratio for infection comparing those who received the vaccine to those who did not receive the vaccine among black participants.
*H0: OR = 1
*H1: OR ≠ 1
*Set α = 0.05

**Step 2: Calculate expected frequencies.  Write down assumptions and test statistic.**
```{r error=FALSE, message=FALSE, warning=FALSE}
a.b <- (13*203)/314
b.b <- (13*111)/314
c.b <- (301*203)/314
d.b <- (301*111)/314
a.b
b.b
c.b
d.b
```

**The assumptions are not satisfied because not all expected cell counts have a frequency greater or equal to 5. Therefore we need to use Fisher’s Exact test to determine if there is an association between stroke status and mobility.**

```{r error=FALSE, message=FALSE, warning=FALSE}
fisher.test(vac.b) 
```
**Step 3: test**

Fishers OR: 0.2289556 

**Step 4: decision**


**Step 5: conclusion**

Asian and other participants
```{r error=FALSE, message=FALSE, warning=FALSE}
vac.ao <- matrix(c(8, 8, 116, 52), 2, 2, byrow=TRUE)
epi.2by2(vac.ao)
tab2by2.test(vac.ao, y = NULL,correction = FALSE) 
```

**Step 1. Write H0, H1 and alpha**
*OR = odds ratio for infection comparing those who received the vaccine to those who did not receive the vaccine among black participants.
*H0: OR = 1
*H1: OR ≠ 1
*Set α = 0.05

**Step 2: Calculate expected frequencies.  Write down assumptions and test statistic.**
```{r error=FALSE, message=FALSE, warning=FALSE}
a.ao <- (16*124)/184
b.ao <- (16*60)/184
c.ao <- (301*124)/184
d.ao <- (301*60)/184
a.ao
b.ao
c.ao
d.ao
```

**The assumptions are satisfied because all expected cell counts have a frequency greater or equal to 5.**

```{r error=FALSE, message=FALSE, warning=FALSE}
chisq.test(vac.ao) 
```

**Step 3: test**
Under H0, X^2 ~ X^2 1
Pearson's Chi-squared test with Yates' continuity correction
X-squared = 1.623, df = 1, p-value = 0.2027

**Step 4: decision**
These data do not provide sufficient evidence to reject the null hypothesis.

**Step 5: conclusion**
At the 5% level of significance, we do not have enough evidence to reject the null hypothesis and conclude that there is a significant association between receiving the vaccine and developing an infection among asian and other patients.

<h3>3.d.</h3>  
Does race modify the relationship between treatment and infection status?  Justify your response.  If race is an effect modifier, explain how it modifies the relationship between treatment and infection status.  If race is not an effect modifier, explain what you would be interested in reporting if it actually were.

The crude odds ratio is:
The odds ratio for infection comparing those who received the vaccine among white participants is:
The odds ratio for infection comparing those who received the vaccine among black participants is:
The odds ratio for infection comparing those who received the vaccine among asian and other participants is:

<h3>3.e.</h3> 
Using a stratified analysis, obtain the estimate of the Mantel-Haenszel common OR and it’s 95% confidence interval.  Interpret both.  Are these measures useful?  Explain why or why not.

<h3>3.f.</h3>
Based on part (e), do you think race confounds the relationship between treatment and infection status?  Explain your response.  (Regardless of whether it is true or not, assume that race satisfies all conditions for being a potential confounder…you don’t need to check for this exercise.)

<h3>3.g.</h3>
What are the null and alternative hypotheses corresponding to the Cochran Mantel-Haenszel test?  Report the value of the test statistic and corresponding p-value for this test.  Is the CMH test valid in this setting?

ORcmh:
P-value:
H0: ORmh = 1
H1: ORmh ≠ 1

When there is no interaction occuring and the ORs are homogenous, the Cochrane Mantel-Haenszel is the estimator of the common OR adjusting for the third variable, in this case race. The Cochrane Mantel-Haenszel test determines whether there is truly an association between the vaccine and infection status or whether the association is due to sampling variability. 

<h3>3.h.</h3>
Write a brief summary of your findings.  Be sure to address the research interests and report your analysis in clear and understandable language.  Assume that the investigators to whom you are reporting have very limited understanding of statistical techniques.    

<h3>4.</h3>  
A retrospective study was conducted to investigate the effects of aluminum on the development of Alzheimer’s disease.  Researchers compared a group of 177 Alzheimer’s patients with a control group of 158 subjects who did not have the disease.  Each subject was classified according to the use of antacids that contain aluminum.  The data are provided in the table below:

  Antacid Use
	None	Low	Medium	High
Diseased	109	13	23	32
Not Diseased	123	12	13	10

```{r}
ant <- epitable(109, 123, 13, 12, 23, 13, 32, 10, ncol =2, byrow = TRUE)
alz <- read.csv("~/Desktop/git/bugfree-bear/bugfree-bear/alz.csv")
```

<h3>4.a.</h3>  
Perform an overall test for association between antacid use and disease status ignoring the ordinal nature of the exposure variable.  Be sure to explain your findings.

**Step 1. Write H0, H1 and alpha**
*OR = odds ratio for alzheimers disease comparing those who used antacids compated to those who did not use antacids.
*H0: OR = 1
*H1: OR ≠ 1
*Set α = 0.05
**The assumptions are satisfied because all expected cell counts have a frequency greater or equal to 5.**

```{r}
chisq.test(ant) 
```
**Step 3: test**
Under H0, X^2 ~ X^2 1
Pearson's Chi-squared test with Yates' continuity correction
X-squared = 14.154, df = 3, p-value = 0.002702

**Step 4: decision**
These data provide sufficient evidence to reject the null hypothesis.

**Step 5: conclusion**
At the 5% level of significance, there is enough evidence to reject the null hypothesis and conclude that there is a significant association between using antacids and alzheimers disease.

<h3>4.b.</h3>  
Assign the scores 0, 1, 2, and 3 to the exposure levels and perform a trend test to determine if antacid use is associated with Alzheimer’s disease.

```{r}

```

<h3>4.c.</h3>  
Complete the table below with information found in parts (a) and (b).

*Test	Test Statistic:
*Value	Null:
*Distribution df	p-value:
*Pearson Chi-Squared Test:			
*C-A Trend Test:

What observations do you make based on this table.  (There are no wrong answers here.)	 

<h3>4.d.</h3>  
In a short paragraph, explain your findings in part (b).  Be sure to indicate the direction of association if there is an association.

ant.alz <- data.frame(dose = rep(c(232, 25, 36, 42)), 
                                 c(0, 1, 2, 3)),
                      alz = c(rep(c(0, 1), c(109, 123)),
                              rep(c(0, 1), c(13, 12)),
                              rep(c(0, 1), c(23, 13)),
                              rep(c(0, 1), c(32, 10)))
table(ant.alz)
independence_test(alz ~ dose, data = ant.alz, teststat = "quad")
